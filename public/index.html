<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Trivia Before Meeting</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f0f8ff; overflow-x: hidden; }
        .correct-answer { background-color: darkgreen; color: white; padding: 15px; border-radius: 8px; font-weight: bold; margin: 10px auto; width: 400px; }
        .option { padding: 15px; border: 2px solid #ccc; margin: 10px auto; width: 400px; border-radius: 8px; background-color: white; }
        #special-message { color: red; font-weight: bold; font-size: 1.5em; display: none; margin-bottom: 20px; animation: blink 1s infinite; }
        #timer-display { font-size: 3.5em; margin-bottom: 20px; font-weight: bold; color: #333; }
        #question-text { font-size: 2em; margin-bottom: 20px; color: #0056b3; }
        
        #explanation-box { display: none; margin: 20px auto; padding: 15px; width: 60%; background-color: #fff3cd; border-left: 5px solid #ffc107; border-radius: 5px; font-size: 1.2em; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        #start-screen { margin-top: 100px; }
        .start-btn { font-size: 1.5em; padding: 15px 40px; background-color: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; }

        /* üèÉ‚Äç‚ôÇÔ∏è ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡πà‡∏ß‡∏¥‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô */
        #track-container {
            width: 80%;
            max-width: 600px;
            height: 50px;
            margin: 20px auto 40px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
            border-bottom: 4px dashed #aaa; /* ‡πÄ‡∏™‡πâ‡∏ô‡∏•‡∏π‡πà‡∏ß‡∏¥‡πà‡∏á */
            position: relative;
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏° */
        }
        #runner {
            font-size: 40px;
            position: absolute;
            bottom: -10px; /* ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πâ‡∏≤‡∏¢‡∏∑‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏û‡∏≠‡∏î‡∏µ */
            left: 0; /* ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
            transition: left 1s linear; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô‡πÜ ‡∏ï‡∏≤‡∏°‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ */
            transform: translateX(-50%); /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ */
            z-index: 2;
        }
        #finish-line {
            font-size: 40px;
            position: absolute;
            bottom: -10px;
            right: 0;
            transform: translateX(50%);
        }
        
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h1>
        <p id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        <button id="start-btn" class="start-btn" onclick="startGame()" style="display: none;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ 20 ‡∏ô‡∏≤‡∏ó‡∏µ</button>
    </div>

    <div id="game-screen" style="display: none;">
        <div id="timer-display">20:00</div>
        <div id="special-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ Meeting!</div>

        <div id="track-container">
            <div id="runner">üèÉ‚Äç‚ôÇÔ∏è</div> <div id="finish-line">üèÅ</div>
        </div>

        <div id="question-container">
            <h2 id="question-text">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°...</h2>
            <div id="options-container"></div>
            <div id="explanation-box"></div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let questions = [];
        let tracks = [];
        let specialMessageText = "";
        let bgAudio = new Audio(); 

        let totalSeconds = 20 * 60;
        let phaseSeconds = 0; 
        let currentQuestionIndex = 0;
        let isAnswerPhase = false; 
        let timerInterval;

        let questionTimeLimit = 120;
        let answerTimeLimit = 60;

        window.onload = async () => {
            try {
                const qRes = await fetch(`${API_URL}/questions/random`);
                questions = await qRes.json();

                const tRes = await fetch(`${API_URL}/tracks`);
                tracks = await tRes.json();

                const sRes = await fetch(`${API_URL}/settings`);
                const settings = await sRes.json();
                
                specialMessageText = settings.specialMessage;
                document.getElementById('special-message').innerText = specialMessageText;
                
                if(settings.questionTime) questionTimeLimit = settings.questionTime;
                if(settings.answerTime) answerTimeLimit = settings.answerTime;

                if (questions.length > 0) {
                    document.getElementById('loading-text').style.display = 'none';
                    document.getElementById('start-btn').style.display = 'inline-block';
                } else {
                    document.getElementById('loading-text').innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö";
                }
            } catch (error) {
                console.error(error);
            }
        };

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            
            if (tracks.length > 0) {
                const randomTrack = tracks[Math.floor(Math.random() * tracks.length)];
                bgAudio.src = randomTrack.url;
                bgAudio.loop = true; 
                bgAudio.volume = 0.4; 
                bgAudio.play().catch(e => console.log("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:", e));
            }

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°
            document.getElementById('runner').style.left = '0%';
            
            updateDisplay(); 
            timerInterval = setInterval(tick, 1000); 
        }

        function tick() {
            if (totalSeconds <= 0) {
                clearInterval(timerInterval);
                document.getElementById('question-text').innerText = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö!";
                document.getElementById('options-container').innerHTML = "";
                document.getElementById('explanation-box').style.display = 'none';
                document.getElementById('special-message').style.display = 'none';
                document.getElementById('track-container').style.display = 'none';
                bgAudio.pause(); 
                return;
            }

            totalSeconds--;
            phaseSeconds++;

            if (!isAnswerPhase && phaseSeconds >= questionTimeLimit) {
                isAnswerPhase = true;
                phaseSeconds = 0;
            } 
            else if (isAnswerPhase && phaseSeconds >= answerTimeLimit) {
                isAnswerPhase = false;
                phaseSeconds = 0;
                currentQuestionIndex++;
                if(currentQuestionIndex >= questions.length) currentQuestionIndex = questions.length - 1; 
            }

            updateDisplay();
        }

        function updateDisplay() {
            const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const s = (totalSeconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;

            if (totalSeconds <= 180 && totalSeconds > 0) {
                document.getElementById('special-message').style.display = 'block';
            } else {
                document.getElementById('special-message').style.display = 'none';
            }

            const q = questions[currentQuestionIndex];
            if (q) {
                document.getElementById('question-text').innerText = isAnswerPhase ? `‡πÄ‡∏â‡∏•‡∏¢: ${q.text}` : `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${currentQuestionIndex + 1}: ${q.text}`;
                
                const optionsHtml = q.options.map((opt, index) => {
                    const isCorrectClass = (isAnswerPhase && index === q.answerIndex) ? 'correct-answer' : 'option';
                    return `<div class="${isCorrectClass}">${opt}</div>`;
                }).join('');
                document.getElementById('options-container').innerHTML = optionsHtml;

                const expBox = document.getElementById('explanation-box');
                const trackContainer = document.getElementById('track-container');
                const runner = document.getElementById('runner');

                if (isAnswerPhase) {
                    // ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏â‡∏•‡∏¢: ‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ ‡∏ã‡πà‡∏≠‡∏ô‡∏•‡∏π‡πà‡∏ß‡∏¥‡πà‡∏á
                    trackContainer.style.display = 'none';
                    
                    if (q.explanation) {
                        expBox.innerHTML = `<strong>üí° ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</strong><br> ${q.explanation}`;
                        expBox.style.display = 'block';
                    } else {
                        expBox.style.display = 'none';
                    }
                } else {
                    // ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: ‡πÇ‡∏ä‡∏ß‡πå‡∏•‡∏π‡πà‡∏ß‡∏¥‡πà‡∏á ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
                    expBox.style.display = 'none';
                    trackContainer.style.display = 'block';
                    
                    // üèÉ‚Äç‚ôÇÔ∏è ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á (‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ / ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î * 100)
                    let progressPercent = (phaseSeconds / questionTimeLimit) * 100;
                    if (progressPercent > 100) progressPercent = 100; // ‡∏Å‡∏±‡∏ô‡∏ó‡∏∞‡∏•‡∏∏‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡∏¢
                    
                    runner.style.left = `${progressPercent}%`;
                }
            }
        }
    </script>
</body>
</html>
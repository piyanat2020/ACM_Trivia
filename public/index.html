<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Trivia Before Meeting</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f0f8ff; }
        .correct-answer { background-color: darkgreen; color: white; padding: 15px; border-radius: 8px; font-weight: bold; margin: 10px auto; width: 400px; }
        .option { padding: 15px; border: 2px solid #ccc; margin: 10px auto; width: 400px; border-radius: 8px; background-color: white; }
        #special-message { color: red; font-weight: bold; font-size: 1.5em; display: none; margin-bottom: 20px; animation: blink 1s infinite; }
        #timer-display { font-size: 3.5em; margin-bottom: 20px; font-weight: bold; color: #333; }
        #question-text { font-size: 2em; margin-bottom: 20px; color: #0056b3; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡πÄ‡∏â‡∏•‡∏¢ */
        #explanation-box { display: none; margin: 20px auto; padding: 15px; width: 60%; background-color: #fff3cd; border-left: 5px solid #ffc107; border-radius: 5px; font-size: 1.2em; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        #start-screen { margin-top: 100px; }
        .start-btn { font-size: 1.5em; padding: 15px 40px; background-color: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h1>
        <p id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        <button id="start-btn" class="start-btn" onclick="startGame()" style="display: none;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ 20 ‡∏ô‡∏≤‡∏ó‡∏µ</button>
    </div>

    <div id="game-screen" style="display: none;">
        <div id="timer-display">20:00</div>
        <div id="special-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ Meeting!</div>

        <div id="question-container">
            <h2 id="question-text">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°...</h2>
            <div id="options-container"></div>
            <div id="explanation-box"></div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let questions = [];
        let tracks = [];
        let specialMessageText = "";
        let bgAudio = new Audio(); // ‡∏≠‡∏≠‡∏ö‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á

        let totalSeconds = 20 * 60;
        let phaseSeconds = 0; 
        let currentQuestionIndex = 0;
        let isAnswerPhase = false; 
        let timerInterval;

        window.onload = async () => {
            try {
                const qRes = await fetch(`${API_URL}/questions/random`);
                questions = await qRes.json();

                const tRes = await fetch(`${API_URL}/tracks`);
                tracks = await tRes.json();

                const sRes = await fetch(`${API_URL}/settings`);
                const settings = await sRes.json();
                specialMessageText = settings.specialMessage;
                document.getElementById('special-message').innerText = specialMessageText;

                if (questions.length > 0) {
                    document.getElementById('loading-text').style.display = 'none';
                    document.getElementById('start-btn').style.display = 'inline-block';
                } else {
                    document.getElementById('loading-text').innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö";
                }
            } catch (error) {
                console.error(error);
            }
        };

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            
            // üéµ ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á
            if (tracks.length > 0) {
                const randomTrack = tracks[Math.floor(Math.random() * tracks.length)];
                bgAudio.src = randomTrack.url;
                bgAudio.loop = true; // ‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏ô‡∏ã‡πâ‡∏≥
                bgAudio.volume = 0.4; // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ö‡∏≤‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (0.0 - 1.0)
                bgAudio.play().catch(e => console.log("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:", e));
            }

            updateDisplay(); 
            timerInterval = setInterval(tick, 1000); 
        }

        function tick() {
            if (totalSeconds <= 0) {
                clearInterval(timerInterval);
                document.getElementById('question-text').innerText = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö!";
                document.getElementById('options-container').innerHTML = "";
                document.getElementById('explanation-box').style.display = 'none';
                document.getElementById('special-message').style.display = 'none';
                bgAudio.pause(); // ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤
                return;
            }

            totalSeconds--;
            phaseSeconds++;

            // ‡∏Ñ‡∏£‡∏ö 2 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° -> ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏•‡∏¢
            if (!isAnswerPhase && phaseSeconds >= 2 * 60) {
                isAnswerPhase = true;
                phaseSeconds = 0;
            } 
            // ‡∏Ñ‡∏£‡∏ö 1 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏â‡∏•‡∏¢ -> ‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            else if (isAnswerPhase && phaseSeconds >= 1 * 60) {
                isAnswerPhase = false;
                phaseSeconds = 0;
                currentQuestionIndex++;
                if(currentQuestionIndex >= questions.length) currentQuestionIndex = questions.length - 1; 
            }

            updateDisplay();
        }

        function updateDisplay() {
            const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const s = (totalSeconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;

            if (totalSeconds <= 180 && totalSeconds > 0) {
                document.getElementById('special-message').style.display = 'block';
            } else {
                document.getElementById('special-message').style.display = 'none';
            }

            const q = questions[currentQuestionIndex];
            if (q) {
                document.getElementById('question-text').innerText = isAnswerPhase ? `‡πÄ‡∏â‡∏•‡∏¢: ${q.text}` : `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${currentQuestionIndex + 1}: ${q.text}`;
                
                const optionsHtml = q.options.map((opt, index) => {
                    const isCorrectClass = (isAnswerPhase && index === q.answerIndex) ? 'correct-answer' : 'option';
                    return `<div class="${isCorrectClass}">${opt}</div>`;
                }).join('');
                document.getElementById('options-container').innerHTML = optionsHtml;

                // üí° ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
                const expBox = document.getElementById('explanation-box');
                if (isAnswerPhase && q.explanation) {
                    expBox.innerHTML = `<strong>üí° ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</strong><br> ${q.explanation}`;
                    expBox.style.display = 'block';
                } else {
                    expBox.style.display = 'none';
                }
            }
        }
    </script>
</body>
</html>